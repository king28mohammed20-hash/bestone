{% extends "base.html" %}
{% block title %}فيديوهاتنا{% endblock %}

{% block content %}
<div class="container my-4">
  <h3 class="mb-3">فيديوهات من شغلنا</h3>

  <style>
    .vid-card { position: relative; overflow: hidden; }
    .vid-thumb { width: 100%; height: 200px; object-fit: cover; background:#f7f7f7; }
    .vid-play {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(transparent, rgba(0,0,0,.35));
      color: #fff; font-weight: 700;
    }
    .vid-play .btn {
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }
    @media (min-width: 992px){ .vid-thumb{ height: 180px; } }
  </style>

  <div class="row g-4">
    {% for v in items %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm vid-card">
          {% if v.source == 'youtube' and v.youtube_id %}
            <img class="vid-thumb" loading="lazy" decoding="async"
                 src="https://i.ytimg.com/vi/{{ v.youtube_id }}/hqdefault.jpg"
                 alt="{{ v.title }}">
          {% elif v.source == 'mp4' and v.file_path %}
            <img class="vid-thumb" loading="lazy" decoding="async"
                 src="{{ url_for('static', filename=v.poster_path) if v.poster_path else url_for('static', filename='placeholder-16x9.png') }}"
                 alt="{{ v.title }}">
          {% else %}
            <div class="vid-thumb d-flex align-items-center justify-content-center text-muted">لا يمكن عرض المعاينة</div>
          {% endif %}

          <div class="vid-play">
            <button class="btn btn-light btn-sm"
                    data-bs-toggle="modal" data-bs-target="#videoModal"
                    data-source="{{ v.source }}"
                    data-ytid="{{ v.youtube_id or '' }}"
                    data-mp4="{{ url_for('static', filename=v.file_path) if v.file_path else '' }}"
                    data-title="{{ v.title|e }}">
              ▶ تشغيل
            </button>
          </div>

          <div class="card-body">
            <h6 class="card-title mb-1">{{ v.title }}</h6>
            {% if v.description %}<p class="card-text small text-muted">{{ v.description }}</p>{% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <div class="col-12">
        <div class="alert alert-info">لا توجد فيديوهات حتى الآن.</div>
      </div>
    {% endfor %}
  </div>

  <!-- ترقيم الصفحات -->
  {% if pages > 1 %}
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if page<=1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('videos_page', page=page-1) }}">السابق</a>
      </li>
      {% for p in range(1, pages+1) %}
      <li class="page-item {% if p==page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('videos_page', page=p) }}">{{ p }}</a>
      </li>
      {% endfor %}
      <li class="page-item {% if page>=pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('videos_page', page=page+1) }}">التالي</a>
      </li>
    </ul>
  </nav>
  {% endif %}
</div>

<!-- مودال تشغيل الفيديو -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">تشغيل الفيديو</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body p-0">
        <div id="videoContainer" class="ratio ratio-16x9"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const modalEl = document.getElementById('videoModal');
  const container = document.getElementById('videoContainer');

  modalEl.addEventListener('show.bs.modal', function (ev) {
    const btn = ev.relatedTarget;
    if(!btn) return;
    const source = btn.getAttribute('data-source');
    const title  = btn.getAttribute('data-title') || 'تشغيل الفيديو';

    modalEl.querySelector('.modal-title').textContent = title;

    if (source === 'youtube') {
      const ytid = btn.getAttribute('data-ytid');
      container.innerHTML =
        '<iframe src="https://www.youtube-nocookie.com/embed/'+ ytid +'?autoplay=1&rel=0&modestbranding=1" ' +
        'title="'+ title +'" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen ' +
        'style="width:100%;height:100%;border:0;"></iframe>';
    } else if (source === 'mp4') {
      const mp4 = btn.getAttribute('data-mp4');
      container.innerHTML =
        '<video controls autoplay preload="none" style="width:100%;height:100%;">' +
        '<source src="'+ mp4 +'" type="video/mp4">متصفحك لا يدعم تشغيل الفيديو.</video>';
    } else {
      container.innerHTML = '<div class="d-flex align-items-center justify-content-center text-muted">لا يمكن تشغيل هذا الفيديو</div>';
    }
  });

  modalEl.addEventListener('hidden.bs.modal', function(){
    container.innerHTML = ""; // يوقف التشغيل
  });
});
</script>
{% endblock %}
